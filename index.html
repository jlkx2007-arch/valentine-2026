<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Will You Be My Valentine? ‚ù§Ô∏è</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&family=Jost:wght@200;300;400&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê‚ïê PROPOSAL PAGE STYLES ‚ïê‚ïê‚ïê */
#proposal-page{
    position:fixed;inset:0;z-index:10000;
    background:radial-gradient(ellipse at 55% 40%,#180a30,#03020a 70%);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    opacity:1;transition:opacity 1.5s;
}
#proposal-page.hidden{opacity:0;pointer-events:none;}

.prop-photo{
    width:320px;height:320px;border-radius:50%;object-fit:cover;
    border:6px solid rgba(255,77,133,.4);
    box-shadow:0 0 60px rgba(255,77,133,.3),0 20px 80px rgba(0,0,0,.6);
    margin-bottom:40px;
}

.prop-question{
    font-family:'Cormorant Garamond',serif;font-size:48px;font-weight:300;
    font-style:italic;letter-spacing:2px;text-align:center;
    background:linear-gradient(135deg,#ff4d85,#c97bff);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    background-clip:text;margin:0 0 50px;line-height:1.3;padding:0 20px;
}

.prop-buttons{display:flex;gap:30px;flex-wrap:wrap;justify-content:center;}

.prop-btn{
    padding:18px 50px;border-radius:14px;border:none;
    font-family:'Jost',sans-serif;font-size:16px;letter-spacing:2px;
    text-transform:uppercase;cursor:pointer;transition:all .3s;
    font-weight:400;position:relative;
}

.btn-yes{
    background:linear-gradient(135deg,#ff4d85,#c97bff);
    color:#fff;box-shadow:0 8px 40px rgba(255,77,133,.5);
}
.btn-yes:hover{
    transform:translateY(-3px);box-shadow:0 12px 50px rgba(255,77,133,.7);
}

.btn-no{
    background:rgba(255,255,255,.08);color:rgba(255,255,255,.6);
    border:1px solid rgba(255,255,255,.15);
}
.btn-no:hover{
    background:rgba(255,255,255,.12);color:rgba(255,255,255,.8);
}

/* Hearts explosion */
.heart-particle{
    position:fixed;font-size:24px;pointer-events:none;z-index:10001;
    animation:heartFloat 2s ease-out forwards;
}

/* ‚ïê‚ïê‚ïê MEMORIES INTERFACE ‚ïê‚ïê‚ïê */
:root{
    --glass:rgba(8,6,14,.65);--border:rgba(255,255,255,.08);
    --accent:#ff4d85;--accent2:#c97bff;--accent3:#4dd8ff;
    --ui:'Jost',sans-serif;--serif:'Cormorant Garamond',serif;
}
*,*::before,*::after{box-sizing:border-box}
body,html{margin:0;padding:0;width:100vw;height:100vh;overflow:hidden;
    background:#03020a;font-family:var(--ui);color:#fff}
body.dragging{cursor:grabbing!important}
#canvas-container{position:absolute;inset:0;z-index:1}

/* Loading */
#loading{position:absolute;inset:0;z-index:9999;
    background:radial-gradient(ellipse at 55% 40%,#180a30,#03020a 70%);
    display:flex;flex-direction:column;justify-content:center;align-items:center;gap:14px;
    transition:opacity 1.2s ease}
.spin-ring{width:48px;height:48px;position:relative}
.spin-ring::before,.spin-ring::after{content:'';position:absolute;inset:0;
    border-radius:50%;border:2px solid transparent}
.spin-ring::before{border-top-color:var(--accent);animation:spin 1.1s linear infinite}
.spin-ring::after{border-right-color:var(--accent2);animation:spin 1.8s linear infinite reverse}
@keyframes spin{to{transform:rotate(360deg)}}
#load-title{font-family:var(--serif);font-size:26px;font-weight:300;
    letter-spacing:4px;color:rgba(255,255,255,.9);font-style:italic}
#load-txt{font-size:10px;letter-spacing:2px;text-transform:uppercase;
    color:rgba(255,255,255,.3);text-align:center;max-width:260px;line-height:1.8}
#btn-mouse{margin-top:4px;background:rgba(255,77,133,.1);
    border:1px solid rgba(255,77,133,.35);color:var(--accent);padding:9px 22px;
    border-radius:6px;cursor:pointer;font-family:var(--ui);font-size:11px;
    letter-spacing:1.5px;text-transform:uppercase;transition:all .3s;display:none}
#btn-mouse:hover{background:rgba(255,77,133,.22)}
#auto-note{font-size:9px;color:rgba(255,255,255,.18);letter-spacing:1px;display:none}

/* Left controls panel */
#left-panel{position:absolute;top:20px;left:20px;width:200px;z-index:10;
    background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
    border:1px solid var(--border);border-radius:18px;padding:18px 14px;
    box-shadow:0 8px 40px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.04);
    display:flex;flex-direction:column;gap:10px}
.ptitle{font-size:9px;font-weight:400;text-transform:uppercase;
    letter-spacing:2.5px;color:rgba(255,255,255,.28);margin:0 0 2px}
.pdiv{height:1px;background:var(--border);margin:2px 0}
.sbtn,.abtn{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);
    color:rgba(255,255,255,.72);padding:8px 12px;border-radius:8px;cursor:pointer;
    transition:all .2s;font-family:var(--ui);font-size:11px;letter-spacing:.4px;
    text-align:center;position:relative;overflow:hidden;user-select:none}
.sbtn::before{content:'';position:absolute;inset:0;opacity:0;
    transition:opacity .2s;border-radius:inherit}
[data-shape=heart]::before    {background:linear-gradient(135deg,#ff4d85,#ff9ec8,#ff6ba8)}
[data-shape=flower]::before   {background:linear-gradient(135deg,#ffb347,#ff6b9d,#c77dff,#54d4ff)}
[data-shape=saturn]::before   {background:linear-gradient(135deg,#4dd8ff,#6a5acd,#00d4aa,#4488ff)}
[data-shape=fireworks]::before{background:linear-gradient(135deg,#ffe066,#ff6b35,#ff4d85,#c77dff,#4dd8ff)}
.sbtn span{position:relative;z-index:1}
.sbtn:hover,.abtn:hover{background:rgba(255,255,255,.1);
    border-color:rgba(255,255,255,.2);color:#fff}
.sbtn.active{color:#fff;border-color:transparent}
.sbtn.active::before{opacity:1}
.crow{display:flex;align-items:center;justify-content:space-between;padding:4px 0}
input[type=color]{background:none;border:none;width:26px;height:26px;cursor:pointer;padding:0;border-radius:50%}

/* Volume slider */
#vol-slider{width:100%;appearance:none;height:4px;border-radius:2px;
    background:rgba(255,255,255,.1);outline:none;margin-top:6px}
#vol-slider::-webkit-slider-thumb{appearance:none;width:14px;height:14px;
    border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));
    cursor:pointer;box-shadow:0 0 8px rgba(255,77,133,.5)}
#vol-slider::-moz-range-thumb{width:14px;height:14px;border-radius:50%;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    cursor:pointer;border:none;box-shadow:0 0 8px rgba(255,77,133,.5)}

/* Camera + hand analysis panel */
#cam-panel{position:absolute;bottom:20px;right:20px;z-index:10;
    background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
    border:1px solid var(--border);border-radius:16px;padding:14px;
    box-shadow:0 8px 40px rgba(0,0,0,.6);
    display:flex;flex-direction:column;gap:10px;width:220px}
#cam-wrap{position:relative;width:100%;aspect-ratio:4/3;
    border-radius:10px;overflow:hidden;background:#000;
    border:1px solid var(--border)}
#cam-wrap video{position:absolute;inset:0;width:100%;height:100%;
    object-fit:cover;transform:scaleX(-1);opacity:.85}
#hand-canvas{position:absolute;inset:0;width:100%;height:100%}
#cam-label{position:absolute;top:6px;left:8px;
    font-size:8px;letter-spacing:1.5px;text-transform:uppercase;
    color:rgba(255,255,255,.5);background:rgba(0,0,0,.4);
    padding:2px 6px;border-radius:4px;pointer-events:none}
#no-hand-msg{position:absolute;inset:0;display:flex;align-items:center;
    justify-content:center;font-size:10px;letter-spacing:1px;
    text-transform:uppercase;color:rgba(255,255,255,.25);
    background:rgba(0,0,0,.3);border-radius:10px;pointer-events:none}

/* Hand analysis */
#hand-info{display:flex;flex-direction:column;gap:5px}
.hi-row{display:flex;justify-content:space-between;align-items:center}
.hi-label{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;
    color:rgba(255,255,255,.3)}
.hi-value{font-size:11px;font-family:var(--serif);font-style:italic;
    color:rgba(255,255,255,.85);font-weight:300}
.hi-bar-wrap{width:100%;height:3px;background:rgba(255,255,255,.07);
    border-radius:2px;overflow:hidden}
.hi-bar{height:100%;border-radius:2px;transition:width .15s ease;
    background:linear-gradient(to right,var(--accent),var(--accent2))}
.gesture-badge{display:inline-block;padding:3px 8px;border-radius:4px;
    font-size:9px;letter-spacing:1px;text-transform:uppercase;font-weight:400;
    background:rgba(255,77,133,.15);border:1px solid rgba(255,77,133,.3);
    color:var(--accent);transition:all .3s}
.gesture-badge.open{background:rgba(77,216,255,.15);
    border-color:rgba(77,216,255,.3);color:var(--accent3)}
.gesture-badge.peace{background:rgba(201,123,255,.15);
    border-color:rgba(201,123,255,.3);color:var(--accent2)}
.gesture-badge.point{background:rgba(255,193,71,.15);
    border-color:rgba(255,193,71,.3);color:#ffc147}
.gesture-badge.fist{background:rgba(255,100,60,.15);
    border-color:rgba(255,100,60,.3);color:#ff643c}

/* Dwell ring */
#dwell-ring{position:absolute;pointer-events:none;
    width:56px;height:56px;border-radius:50%;
    transform:translate(-50%,-50%);display:none;z-index:9}
#dwell-ring svg{position:absolute;inset:0;width:100%;height:100%;transform:rotate(-90deg)}
#dwell-arc{fill:none;stroke:var(--accent);stroke-width:2.5;stroke-linecap:round;
    stroke-dasharray:163;stroke-dashoffset:163}
#dwell-dot{position:absolute;width:8px;height:8px;border-radius:50%;
    background:var(--accent);top:50%;left:50%;transform:translate(-50%,-50%);
    box-shadow:0 0 10px var(--accent)}

/* Caption */
#caption{position:absolute;bottom:44px;left:50%;transform:translateX(-50%);z-index:20;
    background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
    border:1px solid var(--border);border-radius:14px;
    padding:16px 36px;text-align:center;
    opacity:0;pointer-events:none;transition:opacity .6s;
    max-width:50%;box-shadow:0 12px 40px rgba(0,0,0,.7);
    font-family:var(--serif);font-size:20px;font-style:italic;
    font-weight:300;letter-spacing:.5px;line-height:1.4;color:rgba(255,255,255,.92)}
#close-hint{font-family:var(--ui);font-size:9px;letter-spacing:2px;
    text-transform:uppercase;color:rgba(255,255,255,.25);display:block;margin-top:6px}

/* Spread bar */
#spread-bar{position:absolute;top:20px;right:240px;z-index:10;
    width:5px;height:110px;background:rgba(255,255,255,.05);border-radius:3px;
    border:1px solid var(--border);overflow:hidden}
#spread-fill{position:absolute;bottom:0;width:100%;height:0%;
    background:linear-gradient(to top,var(--accent),var(--accent2));border-radius:3px}

/* Instructions */
#instr{position:absolute;top:20px;left:50%;transform:translateX(-50%);
    z-index:10;background:var(--glass);padding:10px 18px;border-radius:10px;
    font-size:10px;color:rgba(255,255,255,.35);border:1px solid var(--border);
    pointer-events:none;text-align:center;line-height:1.8;letter-spacing:.2px;
    white-space:nowrap}
#instr b{color:rgba(255,255,255,.6);letter-spacing:1px;
    text-transform:uppercase;font-size:8px}

/* Hand UI overlay */
#hand-ui{position:absolute;inset:0;z-index:8;pointer-events:none;overflow:hidden}
#dot-left{position:absolute;width:22px;height:22px;border-radius:50%;
    transform:translate(-50%,-50%);display:none;
    background:radial-gradient(circle,rgba(77,216,255,.95),rgba(77,216,255,.1));
    box-shadow:0 0 14px rgba(77,216,255,.8),0 0 28px rgba(77,216,255,.3);
    transition:width .08s,height .08s;border:1.5px solid rgba(255,255,255,.4)}
#dot-left.dwelling{width:14px;height:14px;
    background:radial-gradient(circle,#fff,rgba(77,216,255,.5));
    box-shadow:0 0 22px #fff,0 0 40px var(--accent3)}
#dot-right{position:absolute;border-radius:50%;
    transform:translate(-50%,-50%);display:none;
    background:radial-gradient(circle,rgba(255,165,50,.85),rgba(255,165,50,.08));
    box-shadow:0 0 14px rgba(255,165,50,.7);
    border:1.5px solid rgba(255,255,255,.3);
    transition:width .1s,height .1s,background .2s,box-shadow .2s}
#dot-right.orbiting{
    background:radial-gradient(circle,rgba(200,220,255,.95),rgba(120,160,255,.1));
    box-shadow:0 0 18px rgba(160,200,255,.9),0 0 36px rgba(100,150,255,.4);
    border-color:rgba(200,220,255,.6)}
#spread-ring{position:absolute;border-radius:50%;
    transform:translate(-50%,-50%);pointer-events:none;
    border:2px solid rgba(255,165,50,.45);display:none;
    transition:width .1s,height .1s}

@keyframes heartFloat{
    0%{transform:translate(var(--tx, 0), 0) scale(0.5) rotate(0deg);opacity:1;}
    100%{transform:translate(calc(var(--tx, 0) * 1.5), -100vh) scale(1.5) rotate(20deg);opacity:0;}
}

/* Responsive */
@media (max-width: 768px) {
    .prop-question{font-size:36px;padding:0 20px}
    .prop-photo{width:240px;height:240px}
    .prop-buttons{flex-direction:column;gap:20px}
    .prop-btn{width:200px}
    #left-panel, #cam-panel{display:none}
    #instr{font-size:8px;white-space:normal;max-width:90%;
        padding:8px 12px;top:10px}
}
</style>

<script type="importmap">
{"imports":{"three":"https://unpkg.com/three@0.158.0/build/three.module.js","three/addons/":"https://unpkg.com/three@0.158.0/examples/jsm/"}}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
<script src="data.js"></script>
</head>
<body>

<!-- PROPOSAL PAGE -->
<div id="proposal-page">
    <img id="prop-photo-img" class="prop-photo" alt="Us">
    <h1 class="prop-question">Would you be my<br>Valentine date?</h1>
    <div class="prop-buttons">
        <button class="prop-btn btn-yes" id="btn-yes">Yes! ‚ù§Ô∏è</button>
        <button class="prop-btn btn-no" id="btn-no">No</button>
    </div>
</div>

<!-- MEMORIES INTERFACE (hidden initially) -->
<div id="loading" style="display:none">
    <div class="spin-ring"></div>
    <div id="load-title">Loading Memories</div>
    <div id="load-txt">Initializing Hand Tracking‚Ä¶</div>
    <button id="btn-mouse">Continue Without Camera</button>
    <span id="auto-note">Auto-continuing in 2.5 s‚Ä¶</span>
</div>

<div id="left-panel" style="display:none">
    <p class="ptitle">Shape</p>
    <button class="sbtn active" data-shape="heart"><span>‚ô• Heart</span></button>
    <button class="sbtn" data-shape="flower"><span>‚úø Flower</span></button>
    <button class="sbtn" data-shape="saturn"><span>‚äô Saturn</span></button>
    <button class="sbtn" data-shape="fireworks"><span>‚ú¶ Fireworks</span></button>
    <div class="pdiv"></div>
    <div class="crow"><p class="ptitle" style="margin:0">Tint</p>
        <input type="color" id="pcolor" value="#ff4d85"></div>
    <div class="pdiv"></div>
    <p class="ptitle">Audio</p>
    <button class="abtn" id="play-btn">‚è∏ Pause</button>
    <input type="range" id="vol-slider" min="0" max="100" value="70">
    <div class="pdiv"></div>
    <button class="abtn" id="fs-btn">‚õ∂ Fullscreen</button>
</div>

<div id="cam-panel" style="display:none">
    <div class="crow"><p class="ptitle" style="margin:0">üì∑ Live Hand View</p></div>
    <div id="cam-wrap">
        <video id="cam-video" autoplay muted playsinline></video>
        <canvas id="hand-canvas"></canvas>
        <span id="cam-label">Camera Feed</span>
        <div id="no-hand-msg">Show Both Hands</div>
    </div>
    <div id="hand-info">
        <div class="crow" style="margin-bottom:2px">
            <span class="hi-label" style="color:rgba(255,165,50,.7)">‚úã Right ‚Äî Spread</span>
            <span id="r-gesture" class="gesture-badge fist">‚Äî</span>
        </div>
        <div class="hi-row">
            <span class="hi-label" id="r-mode-label">Openness</span>
            <span class="hi-value" id="r-open-val">‚Äî</span>
        </div>
        <div class="hi-bar-wrap">
            <div class="hi-bar" id="r-open-bar" style="width:0%;background:linear-gradient(to right,#ffa532,#ffd080)"></div>
        </div>
        <div class="hi-row">
            <span class="hi-label" id="r-sub-label">Spread</span>
            <span class="hi-value" id="spread-val">‚Äî</span>
        </div>
        <div class="pdiv"></div>
        <div class="crow" style="margin-bottom:2px">
            <span class="hi-label" style="color:rgba(77,216,255,.7)">ü§ö Left ‚Äî Pointer</span>
            <span id="l-gesture" class="gesture-badge open">‚Äî</span>
        </div>
        <div class="hi-row">
            <span class="hi-label">Dwell</span>
            <span class="hi-value" id="l-dwell-val">‚Äî</span>
        </div>
        <div class="hi-bar-wrap">
            <div class="hi-bar" id="l-dwell-bar" style="width:0%;background:linear-gradient(to right,var(--accent3),#a0eeff)"></div>
        </div>
        <div class="hi-row">
            <span class="hi-label">Pointer Pos</span>
            <span class="hi-value" id="l-pos-val">‚Äî</span>
        </div>
    </div>
</div>

<div id="spread-bar" style="display:none"><div id="spread-fill"></div></div>

<div id="instr" style="display:none">
    <span style="color:rgba(255,165,50,.8)"><b>Right Hand</b></span> Open palm ‚Üí spread particles &nbsp;|&nbsp; Fist ‚Üí grab &amp; orbit (sweep left/right) &nbsp;&nbsp;
    <span style="color:rgba(77,216,255,.8)"><b>Left Hand</b></span> Move ‚Üí aim pointer &nbsp;|&nbsp; Hover photo 1s ‚Üí select &nbsp;|&nbsp; Fist ‚Üí deselect
</div>

<div id="caption">
    <span id="cap-txt"></span>
    <span id="close-hint">Open hand to close</span>
</div>

<div id="hand-ui" style="display:none">
    <div id="dot-left"></div>
    <div id="dot-right"></div>
    <div id="spread-ring"></div>
    <div id="dwell-ring">
        <svg viewBox="0 0 52 52"><circle id="dwell-arc" cx="26" cy="26" r="23"/></svg>
        <div id="dwell-dot"></div>
    </div>
</div>

<div id="canvas-container" style="display:none"></div>
<video class="input_video" style="display:none"></video>
<audio id="bg-audio" loop></audio>

<script>
// Check if data is loaded
if (typeof valentineData === 'undefined') {
    document.body.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;text-align:center;padding:20px;background:radial-gradient(ellipse at 55% 40%,#180a30,#03020a 70%)"><h1 style="color:#ff4d85;font-family:Cormorant Garamond,serif;font-size:36px;margin-bottom:20px">‚ùå Data File Missing</h1><p style="color:rgba(255,255,255,.7);max-width:500px;line-height:1.8">Make sure <code style="background:rgba(255,77,133,.2);padding:4px 8px;border-radius:4px;color:#ff4d85">data.js</code> is in the same folder as <code style="background:rgba(255,77,133,.2);padding:4px 8px;border-radius:4px;color:#ff4d85">index.html</code></p></div>';
    throw new Error('valentineData not found');
}

// Load data
const proposalPage = document.getElementById('proposal-page');
const propPhotoImg = document.getElementById('prop-photo-img');
const btnYes = document.getElementById('btn-yes');
const btnNo = document.getElementById('btn-no');

propPhotoImg.src = valentineData.proposalPhoto;

// No button dodges
let dodgeCount = 0;
btnNo.addEventListener('mouseenter', () => {
    const maxX = Math.max(100, window.innerWidth - btnNo.offsetWidth - 50);
    const maxY = Math.max(100, window.innerHeight - btnNo.offsetHeight - 50);
    dodgeCount++;
    const newX = Math.random() * maxX;
    const newY = Math.random() * maxY;
    btnNo.style.position = 'fixed';
    btnNo.style.left = newX + 'px';
    btnNo.style.top = newY + 'px';
    btnNo.style.transition = 'all 0.3s ease-out';
});

// Yes button ‚Üí transition
btnYes.addEventListener('click', () => {
    const rect = btnYes.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    for (let i = 0; i < 50; i++) {
        setTimeout(() => {
            const heart = document.createElement('div');
            heart.className = 'heart-particle';
            heart.textContent = ['‚ù§Ô∏è', 'üíï', 'üíñ', 'üíó', 'üíù'][Math.floor(Math.random() * 5)];
            heart.style.left = centerX + 'px';
            heart.style.top = centerY + 'px';
            const angle = (Math.random() * 360) * (Math.PI / 180);
            const distance = 100 + Math.random() * 200;
            heart.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
            const duration = 1.5 + Math.random() * 0.8;
            heart.style.animationDuration = duration + 's';
            heart.style.animationDelay = Math.random() * 0.2 + 's';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), (duration + 0.2) * 1000);
        }, i * 25);
    }
    setTimeout(() => {
        proposalPage.classList.add('hidden');
        setTimeout(() => {
            proposalPage.style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('left-panel').style.display = 'flex';
            document.getElementById('cam-panel').style.display = 'flex';
            document.getElementById('spread-bar').style.display = 'block';
            document.getElementById('instr').style.display = 'block';
            document.getElementById('hand-ui').style.display = 'block';
            document.getElementById('canvas-container').style.display = 'block';
            const bgAudio = document.getElementById('bg-audio');
            bgAudio.src = valentineData.music;
            bgAudio.volume = 0.7;
            bgAudio.play().catch(() => {
                document.getElementById('play-btn').innerHTML = '‚ñ∂ Play';
            });
            startMemoriesExperience();
        }, 1500);
    }, 1200);
});
</script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer }  from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass }      from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { ShaderPass }      from 'three/addons/postprocessing/ShaderPass.js';

window.startMemoriesExperience = function() {

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCENE SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const container=document.getElementById('canvas-container');
const scene=new THREE.Scene();
scene.fog=new THREE.FogExp2(0x03020a,.012);

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,150);
camera.position.set(0,0,18);

const renderer=new THREE.WebGLRenderer({antialias:false,powerPreference:'high-performance'});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
container.appendChild(renderer.domElement);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SELECTIVE BLOOM SETUP
// Photos stay crisp ‚Äî only particles get the glow effect
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const renderScene = new RenderPass(scene, camera);

// threshold 0.15 = only bright particle cores bloom, dim ones stay crisp
const bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth,innerHeight), 1.4, 0.5, 0.15);

// Step 1: Bloom composer (renders scene with photos hidden ‚Üí only particles bloom)
const bloomComposer = new EffectComposer(renderer);
bloomComposer.renderToScreen = false;
bloomComposer.addPass(renderScene);
bloomComposer.addPass(bloom);

// Step 2: Final composer (renders clean scene + adds bloom texture on top)
const mixPass = new ShaderPass(
    new THREE.ShaderMaterial({
        uniforms: {
            baseTexture: { value: null },
            bloomTexture: { value: bloomComposer.renderTarget2.texture }
        },
        vertexShader: `
            varying vec2 vUv;
            void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.); }
        `,
        fragmentShader: `
            uniform sampler2D baseTexture, bloomTexture;
            varying vec2 vUv;
            void main() {
                gl_FragColor = texture2D(baseTexture, vUv) + texture2D(bloomTexture, vUv);
            }
        `,
        defines: {}
    }), 'baseTexture'
);
mixPass.needsSwap = true;
const composer = new EffectComposer(renderer);
composer.addPass(renderScene);
composer.addPass(mixPass);

// Dark material used to hide photos during the bloom pass
const _darkMat = new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0 });
const _savedMats = {};

function _darkenPhotos() {
    photos.forEach(g => g.children.forEach(c => {
        if (c.isMesh) { _savedMats[c.uuid] = c.material; c.material = _darkMat; }
    }));
}
function _restorePhotos() {
    photos.forEach(g => g.children.forEach(c => {
        if (_savedMats[c.uuid]) { c.material = _savedMats[c.uuid]; delete _savedMats[c.uuid]; }
    }));
}

// Color palettes & shape generators
const PAL={
    heart:   [[1,.30,.52],[1,.62,.76],[1,1,1],[.8,.18,.55],[1,.44,.80],[.95,.75,.90]],
    flower:  [[1,.72,.25],[1,.40,.60],[.78,.46,1],[.28,.94,.78],[1,.86,.38],[.54,.96,.62],[1,.55,.35]],
    saturn:  [[.28,.86,1],[.42,.36,.88],[0,.84,.68],[.75,.92,1],[.52,.38,1],[.20,1,.90],[.60,.82,1]],
    fireworks:[[1,.88,.18],[1,.40,.20],[1,.28,.52],[.78,.46,1],[.28,.86,1],[1,1,1],[.9,.5,.1]]
};
const STAR_T=[[1,1,1],[.7,.82,1],[1,.92,.7],[.82,.72,1],[.7,1,.96],[1,.8,.9]];
function pc(sh,i){const p=PAL[sh],c=p[i%p.length],j=.10;
    return[Math.min(1,c[0]+(Math.random()-.5)*j),
           Math.min(1,c[1]+(Math.random()-.5)*j),
           Math.min(1,c[2]+(Math.random()-.5)*j)]}

const PC=30000,RL=200;
function heartP(){for(let t=0;t<RL;t++){const x=(Math.random()-.5)*3,y=(Math.random()-.5)*3,z=(Math.random()-.5)*3;
    if(Math.pow(x*x+2.25*y*y+z*z-1,3)-x*x*z*z*z-.1125*y*y*z*z*z<0)return{x:x*3.5,y:z*3.5+1,z:-y*3.5}}return{x:0,y:1,z:0}}
function flowerP(){const u=Math.random()*6.28,v=Math.random()*3.14,l=Math.random()<.5?6:12,r=2.8+Math.sin(u*l*.5)*1.9+Math.cos(u*2.5)*.5;
    return{x:r*Math.sin(v)*Math.cos(u),y:r*Math.sin(v)*Math.sin(u),z:r*Math.cos(v)*.3}}
function saturnP(){const rnd=Math.random();
    if(rnd<.22){const r=Math.cbrt(Math.random())*2.7,th=Math.random()*6.28,phi=Math.acos(2*Math.random()-1);
        return{x:r*Math.sin(phi)*Math.cos(th),y:r*Math.cos(phi),z:r*Math.sin(phi)*Math.sin(th)}}
    if(rnd<.88){const b=Math.floor(Math.random()*3),r=3+b*1.1+Math.random()*.85,th=Math.random()*6.28;
        return{x:r*Math.cos(th),y:(Math.random()-.5)*.15,z:r*Math.sin(th)}}
    const r=6.8+Math.random()*1.6,th=Math.random()*6.28;return{x:r*Math.cos(th),y:(Math.random()-.5)*.4,z:r*Math.sin(th)}}
function fireworkP(){const B=[{x:-3.5,y:3.2,z:-2},{x:4.5,y:2.5,z:1.5},{x:.5,y:5.5,z:-4},{x:2.5,y:-2,z:2},{x:-5,y:-1,z:-1},{x:1.5,y:4,z:3}];
    const c=B[Math.floor(Math.random()*B.length)],r=Math.pow(Math.random(),.45)*3.2,th=Math.random()*6.28,phi=Math.acos(2*Math.random()-1),sk=Math.random()<.25?1.6:1;
    return{x:c.x+r*sk*Math.sin(phi)*Math.cos(th),y:c.y+r*Math.cos(phi),z:c.z+r*sk*Math.sin(phi)*Math.sin(th)}}
function starNoiseP(){const g=()=>{let u,v,s;do{u=Math.random()*2-1;v=Math.random()*2-1;s=u*u+v*v}while(s>=1||s===0);return u*Math.sqrt(-2*Math.log(s)/s)};
    return{x:g()*14,y:g()*14,z:g()*14}}

const SH={heart:new Float32Array(PC*3),flower:new Float32Array(PC*3),saturn:new Float32Array(PC*3),fireworks:new Float32Array(PC*3),noise:new Float32Array(PC*3)};
const SC={heart:new Float32Array(PC*3),flower:new Float32Array(PC*3),saturn:new Float32Array(PC*3),fireworks:new Float32Array(PC*3),noise:new Float32Array(PC*3)};
const SS=new Float32Array(PC);
for(let i=0;i<PC;i++){const i3=i*3;
    const h=heartP();    SH.heart[i3]=h.x;    SH.heart[i3+1]=h.y;    SH.heart[i3+2]=h.z;
    const f=flowerP();   SH.flower[i3]=f.x;   SH.flower[i3+1]=f.y;   SH.flower[i3+2]=f.z;
    const s=saturnP();   SH.saturn[i3]=s.x;   SH.saturn[i3+1]=s.y;   SH.saturn[i3+2]=s.z;
    const fw=fireworkP();SH.fireworks[i3]=fw.x;SH.fireworks[i3+1]=fw.y;SH.fireworks[i3+2]=fw.z;
    const n=starNoiseP();SH.noise[i3]=n.x;    SH.noise[i3+1]=n.y;    SH.noise[i3+2]=n.z;
    for(const k of['heart','flower','saturn','fireworks']){const[r,g,b]=pc(k,i);SC[k][i3]=r;SC[k][i3+1]=g;SC[k][i3+2]=b}
    const st=STAR_T[Math.floor(Math.random()*STAR_T.length)];SC.noise[i3]=st[0];SC.noise[i3+1]=st[1];SC.noise[i3+2]=st[2];
    SS[i]=Math.random()<.04?3+Math.random()*2.5:Math.random()<.14?1.6+Math.random()*1.4:.4+Math.random()*1.1}

// Particle system
const geo=new THREE.BufferGeometry();
const posA=new THREE.BufferAttribute(SH.heart.slice(),3);
const tgtA=new THREE.BufferAttribute(SH.heart.slice(),3);
const noiA=new THREE.BufferAttribute(SH.noise,3);
const colA=new THREE.BufferAttribute(SC.heart.slice(),3);
const nclA=new THREE.BufferAttribute(SC.noise,3);
const szA =new THREE.BufferAttribute(SS,1);
geo.setAttribute('position',posA);geo.setAttribute('targetPos',tgtA);
geo.setAttribute('noisePos',noiA);geo.setAttribute('aColor',colA);
geo.setAttribute('aStarColor',nclA);geo.setAttribute('aStarSize',szA);

const pmat=new THREE.ShaderMaterial({
    uniforms:{u_time:{value:0},u_spread:{value:0},u_morph:{value:0},
              u_baseColor:{value:new THREE.Color('#ff4d85')},u_useShape:{value:1},
              u_globalAlpha:{value:1.0}},
    vertexShader:`
        uniform float u_time,u_spread,u_morph;
        attribute vec3 targetPos,noisePos,aColor,aStarColor;
        attribute float aStarSize;
        varying vec3 vColor;varying float vSpread,vStarSize;
        void main(){
            vec3 m=mix(position,targetPos,u_morph);
            vec3 fp=mix(m,noisePos,u_spread);
            fp.y+=sin(u_time*1.6+fp.x*.4+fp.z*.3)*.28*u_spread;
            fp.x+=cos(u_time*1.2+fp.y*.3)*.12*u_spread;
            vec4 mv=modelViewMatrix*vec4(fp,1.);
            float bs=12./-mv.z,ss=aStarSize*(9./-mv.z);
            gl_PointSize=clamp(mix(bs,ss,u_spread),.8,22.);
            gl_Position=projectionMatrix*mv;
            vColor=mix(aColor,aStarColor,u_spread);vSpread=u_spread;vStarSize=aStarSize;
        }`,
    fragmentShader:`
        uniform vec3 u_baseColor;uniform float u_useShape,u_globalAlpha;
        varying vec3 vColor;varying float vSpread,vStarSize;
        void main(){
            vec2 uv=gl_PointCoord-.5;float d=length(uv);if(d>.5)discard;
            float spk=0.;
            if(vSpread>.25&&vStarSize>1.6){
                float sx=abs(uv.x)<.05?.8:0.,sy=abs(uv.y)<.05?.8:0.;
                float d1=abs(uv.x-uv.y)<.05?.5:0.,d2=abs(uv.x+uv.y)<.05?.5:0.;
                spk=max(max(sx,sy),max(d1,d2))*(vSpread-.25)/.75;
            }
            float g=exp(-d*d*10.);
            float a=mix(1.-d*2.,g+spk*1.4,vSpread);a=clamp(a*u_globalAlpha,0.,1.);
            vec3 col=mix(u_baseColor,vColor,u_useShape);
            if(vStarSize>1.6&&vSpread>.4){float c=smoothstep(.18,0.,d);col=mix(col,vec3(1.),c*vSpread*.85);}
            gl_FragColor=vec4(col,a);
        }`,
    transparent:true,depthWrite:false,blending:THREE.AdditiveBlending
});
scene.add(new THREE.Points(geo,pmat));

// Photos
// Elegant corner-accent border ‚Äî thin L-shaped corners, soft inner edge, minimal aesthetic
const FRAME_COLS=[[1,.30,.52],[.78,.46,1],[.28,.86,1],[1,.72,.25],[.28,.94,.78],[1,.55,.80],[.42,.60,1],[1,.86,.38]];
function mkFrame(idx){
    const c=FRAME_COLS[idx%FRAME_COLS.length];
    return new THREE.ShaderMaterial({
        uniforms:{u_time:{value:0},u_color:{value:new THREE.Color(...c)},u_alpha:{value:0}},
        vertexShader:`varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
        fragmentShader:`
            uniform float u_time,u_alpha;uniform vec3 u_color;varying vec2 vUv;
            void main(){
                vec2 uv = vUv;
                float bx = min(uv.x, 1.-uv.x);
                float by = min(uv.y, 1.-uv.y);

                // Thin clean border line
                float lw = 0.010;
                float lineMask = smoothstep(0., lw*0.4, min(bx,by)) * (1.-smoothstep(lw*0.4, lw*1.6, min(bx,by)));

                // Corner accent ‚Äî only show the border in the corner regions (25% of each edge)
                float cs = 0.22;
                float cx = 1.-smoothstep(0., cs, bx);      // near left/right edges
                float cy = 1.-smoothstep(0., cs, by);      // near top/bottom edges
                float cornerWeight = max(cx, cy);           // union of both corner regions

                // Intersection: border line that is ALSO in a corner region
                float cornerLine = lineMask * cornerWeight;

                // Tiny dot accent at the exact corners
                float dx = abs(uv.x - (uv.x < 0.5 ? 0.0 : 1.0));
                float dy = abs(uv.y - (uv.y < 0.5 ? 0.0 : 1.0));
                float cornerDot = 1.-smoothstep(0.006, 0.022, sqrt(dx*dx+dy*dy));

                // Soft inner glow along edges (very subtle)
                float innerGlow = (1.-smoothstep(0., 0.035, min(bx,by))) * 0.05;

                // Slow breathing pulse on corners
                float pulse = sin(u_time * 1.4 + 0.0) * 0.5 + 0.5;

                float totalAlpha = (cornerLine*(0.55 + pulse*0.45) + cornerDot*(0.4+pulse*0.3) + innerGlow) * u_alpha;

                // Corners lean whiter, rest stays tinted
                vec3 cornerColor = mix(u_color, vec3(1.), 0.55);
                vec3 col = mix(u_color * 0.5, cornerColor, cornerWeight);

                gl_FragColor = vec4(col, clamp(totalAlpha, 0., 1.));
            }`,
        transparent:true,depthWrite:false,blending:THREE.AdditiveBlending,side:THREE.DoubleSide
    });
}

const photos=[];
const tl=new THREE.TextureLoader();
const pg=new THREE.Group();scene.add(pg);
const gold=2.3999632297286535;

const SIZES=valentineData.memories.map((_,i)=>{
    const sz=[1.0,1.4,0.8,1.8,1.0,2.0,1.2,0.9,1.6,1.1,0.85,1.5,1.0,1.9,0.8];
    return sz[i%sz.length];
});

valentineData.memories.forEach((d,idx)=>{
    const sc=SIZES[idx];
    const W=sc*1.8,H=sc*1.2,B=sc*0.13;

    const fM=mkFrame(idx);
    const frame=new THREE.Mesh(new THREE.PlaneGeometry(W+B*2,H+B*2),fM);
    frame.position.z=-.01;

    // NormalBlending for photo ‚Äî crisp texture rendering
    const iM=new THREE.MeshBasicMaterial({
        color:0xffffff,
        transparent:true,
        opacity:0,
        side:THREE.DoubleSide,
        blending:THREE.NormalBlending,
        depthWrite:false
    });
    const img=new THREE.Mesh(new THREE.PlaneGeometry(W,H),iM);

    tl.load(d.photo,tex=>{
        tex.colorSpace = THREE.SRGBColorSpace;
        iM.map=tex;
        iM.needsUpdate=true;
    });

    const grp=new THREE.Group();
    grp.add(frame);grp.add(img);

    const polar=Math.acos(1-2*(idx+.5)/valentineData.memories.length);
    const azim=gold*idx;
    const rad=14+(idx%5)*1.8;

    grp.userData={
        caption:d.caption,
        startPos:new THREE.Vector3(0,0,0),
        scatterPos:new THREE.Vector3(
            rad*Math.sin(polar)*Math.cos(azim),
            rad*Math.sin(polar)*Math.sin(azim),
            rad*Math.cos(polar)
        ),
        floatOff:idx*.8,isSelected:false,
        fMat:fM,iMat:iM,imgMesh:img,scale:sc
    };
    photos.push(grp);pg.add(grp);
});

const state={
    spread:0,targetSpread:0,
    camAngleX:0,camAngleY:0,camRadius:18,
    activeShape:'heart',selectedPhoto:null,isMorphing:false,
    focusDim:1.0  // smoothly dims particles when a photo is selected
};
const _tv=new THREE.Vector3(),_mp=new THREE.Vector2();
const raycaster=new THREE.Raycaster();raycaster.params.Mesh.threshold=.05;
let time=0;
const photoMeshes=photos.map(g=>g.userData.imgMesh);

// Backdrop plane ‚Äî invisible quad that fades in behind selected photos for clean focus
const backdropMat = new THREE.MeshBasicMaterial({
    color: 0x03020a, transparent: true, opacity: 0,
    side: THREE.DoubleSide, depthWrite: false
});
const backdropMesh = new THREE.Mesh(
    new THREE.PlaneGeometry(200, 200), backdropMat
);
backdropMesh.renderOrder = -1;  // renders before photos so it's behind them
scene.add(backdropMesh);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BORDER PARTICLE SYSTEM
// Small ambient particles that drift around the border of a selected photo
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BP_COUNT = 280;
const bpPositions  = new Float32Array(BP_COUNT * 3);
const bpColors     = new Float32Array(BP_COUNT * 3);
const bpSizes      = new Float32Array(BP_COUNT);
// Velocity & phase stored in JS (not GPU) for easy per-particle simulation
const bpVel        = Array.from({length: BP_COUNT}, () => ({vx:0, vy:0, bx:0, by:0, phase:0}));

const bpGeo = new THREE.BufferGeometry();
bpGeo.setAttribute('position', new THREE.BufferAttribute(bpPositions, 3));
bpGeo.setAttribute('aColor',   new THREE.BufferAttribute(bpColors,    3));
bpGeo.setAttribute('aSize',    new THREE.BufferAttribute(bpSizes,     1));

const bpMat = new THREE.ShaderMaterial({
    uniforms: { u_alpha: {value: 0.0} },
    vertexShader:`
        attribute vec3 aColor; attribute float aSize;
        varying vec3 vColor;
        uniform float u_alpha;
        varying float vAlpha;
        void main(){
            vColor = aColor; vAlpha = u_alpha;
            vec4 mv = modelViewMatrix * vec4(position, 1.);
            gl_PointSize = aSize * (7. / -mv.z);
            gl_Position = projectionMatrix * mv;
        }`,
    fragmentShader:`
        varying vec3 vColor; varying float vAlpha;
        void main(){
            vec2 uv = gl_PointCoord - 0.5;
            float d = length(uv);
            if(d > 0.5) discard;
            float a = (1. - d * 2.2) * vAlpha;
            gl_FragColor = vec4(vColor, clamp(a, 0., 1.));
        }`,
    transparent:true, depthWrite:false, blending:THREE.AdditiveBlending
});
const bpMesh = new THREE.Points(bpGeo, bpMat);
bpMesh.visible = false;
scene.add(bpMesh);

// Seed border particles along the edges of a photo (world space, relative to photo center)
function seedBorderParticles(grp) {
    const sc = grp.userData.scale;
    const W = sc * 1.8 * 0.5;   // half-width
    const H = sc * 1.2 * 0.5;   // half-height
    const ACCENT = [
        grp.userData.fMat.uniforms.u_color.value.r,
        grp.userData.fMat.uniforms.u_color.value.g,
        grp.userData.fMat.uniforms.u_color.value.b
    ];
    const WHITES = [[1,.9,.95],[.9,.85,1],[.85,.95,1],[1,1,1]];

    for(let i = 0; i < BP_COUNT; i++){
        const edge = Math.floor(Math.random() * 4); // 0=top,1=right,2=bottom,3=left
        let bx = 0, by = 0;
        const spread = (Math.random() - 0.5) * 0.18;  // slight outward spread

        if(edge === 0){ bx = (Math.random()-0.5)*W*2; by =  H + spread; }
        if(edge === 1){ bx =  W + spread; by = (Math.random()-0.5)*H*2; }
        if(edge === 2){ bx = (Math.random()-0.5)*W*2; by = -H + spread; }
        if(edge === 3){ bx = -W + spread; by = (Math.random()-0.5)*H*2; }

        bpVel[i].bx = bx;  // home position on border
        bpVel[i].by = by;
        bpVel[i].vx = (Math.random()-0.5) * 0.004;
        bpVel[i].vy = (Math.random()-0.5) * 0.004;
        bpVel[i].phase = Math.random() * Math.PI * 2;

        bpPositions[i*3  ] = bx;
        bpPositions[i*3+1] = by;
        bpPositions[i*3+2] = 0.02;   // just in front of photo

        // Alternate between accent color and soft white
        const useAccent = Math.random() > 0.45;
        const col = useAccent ? ACCENT : WHITES[Math.floor(Math.random()*WHITES.length)];
        bpColors[i*3  ] = col[0];
        bpColors[i*3+1] = col[1];
        bpColors[i*3+2] = col[2];
        bpSizes[i] = 0.6 + Math.random() * 1.4;
    }
    bpGeo.attributes.position.needsUpdate = true;
    bpGeo.attributes.aColor.needsUpdate   = true;
    bpGeo.attributes.aSize.needsUpdate    = true;
}

// Tick border particles ‚Äî gentle drift + return-to-border force
function tickBorderParticles(dt) {
    const sc = state.selectedPhoto ? state.selectedPhoto.userData.scale : 1;
    const W = sc * 1.8 * 0.5 + 0.12;
    const H = sc * 1.2 * 0.5 + 0.12;
    for(let i = 0; i < BP_COUNT; i++){
        const p = bpVel[i];
        p.phase += 0.018;
        // Drift
        bpPositions[i*3  ] += p.vx + Math.sin(p.phase * 1.3) * 0.0012;
        bpPositions[i*3+1] += p.vy + Math.cos(p.phase * 0.9) * 0.0012;

        // Soft return force toward home position
        bpPositions[i*3  ] += (p.bx - bpPositions[i*3  ]) * 0.018;
        bpPositions[i*3+1] += (p.by - bpPositions[i*3+1]) * 0.018;

        // Bounce slightly if too far
        const dist = Math.max(Math.abs(bpPositions[i*3]), Math.abs(bpPositions[i*3+1]));
        if(dist > Math.max(W, H) + 0.4){
            bpPositions[i*3  ] *= 0.95;
            bpPositions[i*3+1] *= 0.95;
        }
    }
    bpGeo.attributes.position.needsUpdate = true;
}
document.querySelectorAll('.sbtn').forEach(btn=>{
    btn.addEventListener('click',e=>{
        if(state.isMorphing)return;
        document.querySelectorAll('.sbtn').forEach(b=>b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        const ns=e.currentTarget.dataset.shape;
        if(ns===state.activeShape)return;
        state.isMorphing=true;
        colA.array.set(SC[ns]);colA.needsUpdate=true;
        tgtA.array.set(SH[ns]);tgtA.needsUpdate=true;
        gsap.fromTo(pmat.uniforms.u_morph,{value:0},{value:1,duration:1.8,ease:'power2.inOut',
            onComplete(){posA.array.set(SH[ns]);posA.needsUpdate=true;
                pmat.uniforms.u_morph.value=0;state.activeShape=ns;state.isMorphing=false}});
    });
});
document.getElementById('pcolor').addEventListener('input',e=>pmat.uniforms.u_baseColor.value.set(e.target.value));

const bgAudio=document.getElementById('bg-audio');
const volSlider=document.getElementById('vol-slider');
volSlider.addEventListener('input',e=>bgAudio.volume=e.target.value/100);

const playBtn=document.getElementById('play-btn');
playBtn.addEventListener('click',()=>{
    if(bgAudio.paused){bgAudio.play();playBtn.innerHTML='‚è∏ Pause';}
    else{bgAudio.pause();playBtn.innerHTML='‚ñ∂ Play';}
});

document.getElementById('fs-btn').addEventListener('click',()=>{
    if(!document.fullscreenElement)document.documentElement.requestFullscreen();
    else document.exitFullscreen?.();
});

const captEl=document.getElementById('caption');
const capTxt=document.getElementById('cap-txt');
function selectPhoto(grp){
    if(state.selectedPhoto)return;
    state.selectedPhoto=grp;grp.userData.isSelected=true;
    const dir=new THREE.Vector3();camera.getWorldDirection(dir);
    const tp=camera.position.clone().add(dir.multiplyScalar(4.2));
    gsap.to(grp.position,{x:tp.x,y:tp.y,z:tp.z,duration:.85,ease:'power2.out'});
    gsap.to(grp.rotation,{x:camera.rotation.x,y:camera.rotation.y,z:camera.rotation.z,duration:.85});
    // Boost frame corner glow
    gsap.to(grp.userData.fMat.uniforms.u_alpha,{value:1.0,duration:.5});
    // Snap photo to full opacity
    grp.userData.iMat.opacity = 1.0;
    // Backdrop behind photo
    backdropMesh.position.copy(tp).addScaledVector(dir, -0.3);
    backdropMesh.quaternion.copy(camera.quaternion);
    gsap.to(backdropMat, {opacity:0.88, duration:.6, ease:'power2.inOut'});
    // Border particles ‚Äî seed around photo border and fade in
    seedBorderParticles(grp);
    bpMesh.visible = true;
    bpMesh.position.copy(tp);
    bpMesh.quaternion.copy(camera.quaternion);
    gsap.to(bpMat.uniforms.u_alpha, {value:1.0, duration:.8, ease:'power2.out'});
    capTxt.innerText=grp.userData.caption;captEl.style.opacity='1';
}
function deselectPhoto(){
    if(!state.selectedPhoto)return;
    state.selectedPhoto.userData.isSelected=false;state.selectedPhoto=null;
    gsap.to(backdropMat,{opacity:0,duration:.5,ease:'power2.inOut'});
    gsap.to(bpMat.uniforms.u_alpha,{value:0, duration:.4, ease:'power2.in',
        onComplete:()=>{ bpMesh.visible = false; }});
    captEl.style.opacity='0';
}

// Hand tracking (MediaPipe)
function calcOpenness(lm){
    const palmIdx=[0,5,9,13,17];
    let cx=0,cy=0,cz=0;
    palmIdx.forEach(i=>{cx+=lm[i].x;cy+=lm[i].y;cz+=lm[i].z;});
    cx/=5;cy/=5;cz/=5;
    const palmRef=Math.hypot(lm[9].x-lm[0].x,lm[9].y-lm[0].y,lm[9].z-lm[0].z);
    if(palmRef<.001)return 0;
    const tips=[4,8,12,16,20];
    const pips=[2,6,10,14,18];
    let extSum=0;
    for(let f=0;f<5;f++){
        const tD=Math.hypot(lm[tips[f]].x-cx,lm[tips[f]].y-cy,lm[tips[f]].z-cz);
        const pD=Math.hypot(lm[pips[f]].x-cx,lm[pips[f]].y-cy,lm[pips[f]].z-cz);
        const curl=Math.max(0,Math.min(1,(tD-pD*0.95)/(palmRef*0.55)));
        extSum+=curl;
    }
    return extSum/5;
}

function fingerExtended(lm,tip,pip){return lm[tip].y<lm[pip].y;}
function classifyGesture(lm){
    const t=lm[4],i=lm[8];
    const iE=fingerExtended(lm,8,6),mE=fingerExtended(lm,12,10);
    const rE=fingerExtended(lm,16,14),pE=fingerExtended(lm,20,18);
    const pd=Math.hypot(t.x-i.x,t.y-i.y,t.z-i.z);
    if(pd<.055)return{name:'Pinch',cls:''};
    if(iE&&mE&&rE&&pE)return{name:'Open',cls:'open'};
    if(!iE&&!mE&&!rE&&!pE)return{name:'Fist',cls:'fist'};
    if(iE&&mE&&!rE&&!pE)return{name:'Peace ‚úå',cls:'peace'};
    if(iE&&!mE&&!rE&&!pE)return{name:'Point ‚òù',cls:'point'};
    return{name:'Partial',cls:''};
}

const handCvs=document.getElementById('hand-canvas');
const hctx=handCvs.getContext('2d');
const noHandMsg=document.getElementById('no-hand-msg');
const CONN=[[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],
    [0,9],[9,10],[10,11],[11,12],[0,13],[13,14],[14,15],[15,16],
    [0,17],[17,18],[18,19],[19,20],[5,9],[9,13],[13,17]];

function drawSkeleton(lm,w,h,color,tipColor){
    if(!lm)return;
    const mx=pt=>({x:(1-pt.x)*w,y:pt.y*h});
    CONN.forEach(([a,b])=>{
        const pa=mx(lm[a]),pb=mx(lm[b]);
        hctx.beginPath();hctx.moveTo(pa.x,pa.y);hctx.lineTo(pb.x,pb.y);
        hctx.strokeStyle=color;hctx.lineWidth=1.5;hctx.stroke();
    });
    lm.forEach((pt,i)=>{
        const p=mx(pt),tip=[4,8,12,16,20].includes(i);
        hctx.beginPath();hctx.arc(p.x,p.y,tip?4:2.5,0,6.28);
        hctx.fillStyle=tip?tipColor:color;hctx.fill();
    });
}

const videoHidden=document.querySelector('.input_video');
const camVideo=document.getElementById('cam-video');
let useMouseFallback=false,loadingHidden=false;

const dotLeft=document.getElementById('dot-left');
const dotRight=document.getElementById('dot-right');
const spreadRingEl=document.getElementById('spread-ring');
const dwellRing=document.getElementById('dwell-ring');
const dwellArc=document.getElementById('dwell-arc');
const ARC=163,DWELL_MS=900;
let dwellProg=0,dwellTgt=null,dwellT0=null;
const DWELL_RADIUS=60;
let dwellLastX=0,dwellLastY=0;

const rGesture=document.getElementById('r-gesture');
const rOpenVal=document.getElementById('r-open-val');
const rOpenBar=document.getElementById('r-open-bar');
const spreadValEl=document.getElementById('spread-val');
const lGesture=document.getElementById('l-gesture');
const lDwellVal=document.getElementById('l-dwell-val');
const lDwellBar=document.getElementById('l-dwell-bar');
const lPosVal=document.getElementById('l-pos-val');

let smoothOpenness=0;
const OPEN_SMOOTH=0.10;
let prevRWrist=null;
const ORBIT_SENS=0.007;
const FIST_THRESH=0.20;
const OPEN_THRESH=0.30;
let rightMode='spread';

function hideLoading(){
    if(loadingHidden)return;loadingHidden=true;
    const el=document.getElementById('loading');
    el.style.opacity='0';setTimeout(()=>el.style.display='none',1200);
}
function lmSc(lm){return{sx:(1-lm.x)*innerWidth,sy:lm.y*innerHeight};}

function onResults(res){
    hideLoading();
    const lms=res.multiHandLandmarks;
    const labels=res.multiHandedness;

    const cw=handCvs.parentElement.clientWidth;
    const ch=handCvs.parentElement.clientHeight;
    if(handCvs.width!==cw||handCvs.height!==ch){handCvs.width=cw;handCvs.height=ch;}
    hctx.clearRect(0,0,cw,ch);

    if(!lms||!lms.length){
        noHandMsg.style.display='flex';
        dotLeft.style.display=dotRight.style.display='none';
        dwellRing.style.display=spreadRingEl.style.display='none';
        dwellProg=0;dwellTgt=null;dwellT0=null;
        rGesture.textContent='‚Äî';rOpenVal.textContent='‚Äî';rOpenBar.style.width='0%';
        lGesture.textContent='‚Äî';lDwellVal.textContent='‚Äî';lDwellBar.style.width='0%';
        spreadValEl.textContent='‚Äî';lPosVal.textContent='‚Äî';
        return;
    }
    noHandMsg.style.display='none';

    let rightLm=null,leftLm=null;
    lms.forEach((lm,i)=>{
        if(labels&&labels[i]){
            const lab=labels[i].label;
            if(lab==='Left')rightLm=lm; else leftLm=lm;
        } else {
            if(lm[0].x>0.5)leftLm=lm; else rightLm=lm;
        }
    });

    if(rightLm){
        drawSkeleton(rightLm,cw,ch,'rgba(255,165,50,.55)','rgba(255,165,50,1)');
        const rawOpen=calcOpenness(rightLm);
        smoothOpenness+=(rawOpen-smoothOpenness)*OPEN_SMOOTH;
        const openPct=Math.round(smoothOpenness*100);

        if(rightMode==='spread' && smoothOpenness<FIST_THRESH) rightMode='orbit';
        if(rightMode==='orbit'  && smoothOpenness>OPEN_THRESH)  rightMode='spread';

        const rw=lmSc(rightLm[0]);

        if(rightMode==='orbit'){
            state.targetSpread=0;
            if(prevRWrist&&!state.selectedPhoto){
                const dx=rw.sx-prevRWrist.x;
                const dy=rw.sy-prevRWrist.y;
                state.camAngleX-=dx*ORBIT_SENS;
                state.camAngleY+=dy*ORBIT_SENS;
                const HP=Math.PI*.48;
                state.camAngleY=Math.max(-HP,Math.min(HP,state.camAngleY));
            }
            prevRWrist={x:rw.sx,y:rw.sy};

            const dotSz=18;
            dotRight.style.display='block';
            dotRight.classList.add('orbiting');
            dotRight.style.left=rw.sx+'px';dotRight.style.top=rw.sy+'px';
            dotRight.style.width=dotSz+'px';dotRight.style.height=dotSz+'px';
            spreadRingEl.style.display='none';

            rGesture.textContent='Orbit ‚ü≥';rGesture.className='gesture-badge fist';
            document.getElementById('r-mode-label').textContent='Openness';
            document.getElementById('r-sub-label').textContent='Mode';
            rOpenVal.textContent=openPct+'%';
            rOpenBar.style.width=openPct+'%';
            rOpenBar.style.background='linear-gradient(to right,#88aaff,#cce0ff)';
            spreadValEl.textContent='Orbit';
        } else {
            prevRWrist=null;
            state.targetSpread=smoothOpenness;

            const dotSz=Math.round(16+smoothOpenness*32);
            dotRight.style.display='block';
            dotRight.classList.remove('orbiting');
            dotRight.style.left=rw.sx+'px';dotRight.style.top=rw.sy+'px';
            dotRight.style.width=dotSz+'px';dotRight.style.height=dotSz+'px';

            const ringSz=Math.round(50+smoothOpenness*100);
            spreadRingEl.style.display='block';
            spreadRingEl.style.left=rw.sx+'px';spreadRingEl.style.top=rw.sy+'px';
            spreadRingEl.style.width=ringSz+'px';spreadRingEl.style.height=ringSz+'px';
            spreadRingEl.style.opacity=(0.2+smoothOpenness*.5).toFixed(2);

            const rGest=classifyGesture(rightLm);
            rGesture.textContent=rGest.name;rGesture.className='gesture-badge '+(rGest.cls||'');
            document.getElementById('r-mode-label').textContent='Openness';
            document.getElementById('r-sub-label').textContent='Spread';
            rOpenVal.textContent=openPct+'%';
            rOpenBar.style.width=openPct+'%';
            rOpenBar.style.background='linear-gradient(to right,#ffa532,#ffd080)';
            spreadValEl.textContent=(state.spread*100).toFixed(0)+'%';
        }
    } else {
        dotRight.style.display='none';
        dotRight.classList.remove('orbiting');
        spreadRingEl.style.display='none';
        prevRWrist=null;
        state.targetSpread=Math.max(0,state.targetSpread-.02);
        rightMode='spread';
    }

    if(leftLm){
        drawSkeleton(leftLm,cw,ch,'rgba(77,216,255,.55)','rgba(77,216,255,1)');
        const tip=lmSc(leftLm[8]);
        dotLeft.style.display='block';
        dotLeft.style.left=tip.sx+'px';dotLeft.style.top=tip.sy+'px';

        const lGest=classifyGesture(leftLm);
        lGesture.textContent=lGest.name;lGesture.className='gesture-badge '+(lGest.cls||'');
        lPosVal.textContent=(tip.sx/innerWidth*100).toFixed(0)+'% / '+(tip.sy/innerHeight*100).toFixed(0)+'%';

        if(!state.selectedPhoto){
            if(state.spread>.18){
                _mp.set((tip.sx/innerWidth)*2-1,(tip.sy/innerHeight)*-2+1);
                raycaster.setFromCamera(_mp,camera);
                const hits=raycaster.intersectObjects(photoMeshes,false);

                if(hits.length){
                    const hg=hits[0].object.parent;
                    const moved=Math.hypot(tip.sx-dwellLastX,tip.sy-dwellLastY);

                    if(dwellTgt!==hg){
                        dwellTgt=hg;dwellT0=performance.now();dwellProg=0;
                        dwellLastX=tip.sx;dwellLastY=tip.sy;
                    } else if(moved>DWELL_RADIUS){
                        dwellT0=performance.now();dwellProg=0;
                        dwellLastX=tip.sx;dwellLastY=tip.sy;
                    }

                    dwellProg=Math.min((performance.now()-dwellT0)/DWELL_MS,1);
                    dwellArc.style.strokeDashoffset=ARC*(1-dwellProg);
                    dwellRing.style.display='block';
                    dwellRing.style.left=tip.sx+'px';dwellRing.style.top=tip.sy+'px';

                    dotLeft.classList.toggle('dwelling',dwellProg>0.05);

                    lDwellVal.textContent=Math.round(dwellProg*100)+'%';
                    lDwellBar.style.width=Math.round(dwellProg*100)+'%';

                    if(dwellProg>=1){
                        selectPhoto(dwellTgt);
                        dwellProg=0;dwellTgt=null;dwellT0=null;
                        dwellRing.style.display='none';
                        dotLeft.classList.remove('dwelling');
                    }
                } else {
                    dwellRing.style.display='none';
                    dwellProg=0;dwellTgt=null;dwellT0=null;
                    dotLeft.classList.remove('dwelling');
                    lDwellVal.textContent='‚Äî';lDwellBar.style.width='0%';
                }
            } else {
                dwellRing.style.display='none';
                dwellProg=0;dwellTgt=null;dwellT0=null;
                dotLeft.classList.remove('dwelling');
            }
        } else {
            const leftOpen=calcOpenness(leftLm);
            if(leftOpen<0.15){deselectPhoto();}
            dwellRing.style.display='none';
            lDwellVal.textContent='Fist ‚Üí close';
            lDwellBar.style.width='0%';
        }
    } else {
        dotLeft.style.display='none';
        dwellRing.style.display='none';
        dwellProg=0;dwellTgt=null;dwellT0=null;
        dotLeft.classList.remove('dwelling');
    }
}

const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:.6,minTrackingConfidence:.6});
hands.onResults(onResults);

function activateFallback(msg){
    useMouseFallback=true;
    document.getElementById('load-txt').innerText=msg;
    document.getElementById('btn-mouse').style.display='block';
    document.getElementById('auto-note').style.display='block';
    setTimeout(()=>hideLoading(),2500);
}

async function startCamera(){
    if(!navigator.mediaDevices?.getUserMedia){activateFallback('Camera unavailable ‚Äî mouse mode active.');return;}
    let stream;
    try{stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});}
    catch(err){activateFallback(err.name==='NotAllowedError'?'Camera denied ‚Äî mouse mode.':' Camera unavailable ‚Äî mouse mode.');return;}

    camVideo.srcObject=stream;
    try{
        const stream2=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
        videoHidden.srcObject=stream2;
    }catch(_){videoHidden.srcObject=stream.clone();}

    const cu=new Camera(videoHidden,{
        onFrame:async()=>{try{await hands.send({image:videoHidden});}catch(_){}},
        width:640,height:480
    });
    try{await cu.start();}catch(e){activateFallback('Camera failed ‚Äî mouse mode.');}
}
startCamera();
document.getElementById('btn-mouse').addEventListener('click',()=>{useMouseFallback=true;hideLoading();});

// Mouse fallback
let drag={active:false,lastX:0,lastY:0,moved:false};
function onDragStart(x,y){if(!useMouseFallback)return;drag={active:true,lastX:x,lastY:y,moved:false};document.body.classList.add('dragging');}
function onDragMove(x,y){
    if(!useMouseFallback||!drag.active)return;
    const dx=x-drag.lastX,dy=y-drag.lastY;
    if(Math.abs(dx)>2||Math.abs(dy)>2)drag.moved=true;
    state.camAngleX-=dx*.005;state.camAngleY+=dy*.005;
    const HP=Math.PI*.48;state.camAngleY=Math.max(-HP,Math.min(HP,state.camAngleY));
    drag.lastX=x;drag.lastY=y;
}
function onDragEnd(ox,oy){
    if(!useMouseFallback)return;drag.active=false;document.body.classList.remove('dragging');
    if(drag.moved)return;
    if(state.selectedPhoto){deselectPhoto();return;}
    if(state.spread<.25)return;
    _mp.set((ox/innerWidth)*2-1,(oy/innerHeight)*-2+1);
    raycaster.setFromCamera(_mp,camera);
    const hits=raycaster.intersectObjects(photoMeshes,false);
    if(hits.length)selectPhoto(hits[0].object.parent);
}
window.addEventListener('mousedown',e=>{if(e.button!==0)return;onDragStart(e.clientX,e.clientY);
    if(useMouseFallback)state.targetSpread=Math.max(0,(e.clientY/innerHeight-.2)*1.5);});
window.addEventListener('mousemove',e=>{onDragMove(e.clientX,e.clientY);
    if(useMouseFallback&&!drag.active)state.targetSpread=Math.max(0,(e.clientY/innerHeight-.2)*1.5);});
window.addEventListener('mouseup',e=>onDragEnd(e.clientX,e.clientY));
window.addEventListener('wheel',e=>{if(!useMouseFallback)return;state.camRadius=Math.max(6,Math.min(35,state.camRadius+e.deltaY*.02));},{passive:true});
let pd0=0;
window.addEventListener('touchstart',e=>{if(!useMouseFallback)return;e.preventDefault();
    if(e.touches.length===1)onDragStart(e.touches[0].clientX,e.touches[0].clientY);
    else if(e.touches.length===2){pd0=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);drag.active=false;}
},{passive:false});
window.addEventListener('touchmove',e=>{if(!useMouseFallback)return;e.preventDefault();
    if(e.touches.length===1){const t=e.touches[0];onDragMove(t.clientX,t.clientY);state.targetSpread=Math.max(0,(t.clientY/innerHeight-.2)*1.5);}
    else if(e.touches.length===2){const nd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);state.camRadius=Math.max(6,Math.min(35,state.camRadius+(pd0-nd)*.03));pd0=nd;}
},{passive:false});
window.addEventListener('touchend',e=>{if(!useMouseFallback)return;if(e.changedTouches.length)onDragEnd(e.changedTouches[0].clientX,e.changedTouches[0].clientY);});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER LOOP ‚Äî Selective Bloom
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const spreadFill=document.getElementById('spread-fill');
function animate(){
    requestAnimationFrame(animate);
    time+=.01;
    state.spread+=(state.targetSpread-state.spread)*.10;
    pmat.uniforms.u_time.value=time;

    // Smooth particle fade ‚Äî use u_globalAlpha so particles fully disappear on photo select
    const globalAlphaTarget = state.selectedPhoto ? 0.0 : 1.0;
    state.focusDim += (globalAlphaTarget - state.focusDim) * 0.07;
    pmat.uniforms.u_globalAlpha.value = state.focusDim;
    pmat.uniforms.u_spread.value = state.spread;   // spread stays intact for heart shape
    bloom.strength = THREE.MathUtils.lerp(state.activeShape==='heart'?1.4:.4, 2.0, state.spread) * Math.max(state.focusDim, 0.0);
    bloom.radius = THREE.MathUtils.lerp(.45, 1.0, state.spread);
    spreadFill.style.height=(state.spread*100).toFixed(1)+'%';

    if(!state.selectedPhoto){
        const tx=Math.sin(state.camAngleX)*Math.cos(state.camAngleY)*state.camRadius;
        const ty=Math.sin(state.camAngleY)*state.camRadius;
        const tz=Math.cos(state.camAngleX)*Math.cos(state.camAngleY)*state.camRadius;
        camera.position.x+=(tx-camera.position.x)*.06;
        camera.position.y+=(ty-camera.position.y)*.06;
        camera.position.z+=(tz-camera.position.z)*.06;
        camera.lookAt(0,0,0);
    }
    if(state.activeShape==='heart'&&!state.selectedPhoto&&rightMode!=='orbit')scene.rotation.y=time*.09;
    else scene.rotation.y*=.96;

    photos.forEach((grp)=>{
        if(grp.userData.isSelected){
            grp.userData.iMat.opacity = 1.0;
            grp.userData.fMat.uniforms.u_time.value=time;
            return;
        }
        const inFocus = state.selectedPhoto !== null;
        const opT = inFocus ? 0 : (state.spread>.22 ? 1 : 0);
        grp.userData.iMat.opacity+=(opT-grp.userData.iMat.opacity)*.06;
        const fa=grp.userData.fMat.uniforms.u_alpha;
        const frameTarget= inFocus ? 0 : (state.spread>.22?0.2:0);
        fa.value+=(frameTarget-fa.value)*.06;
        grp.userData.fMat.uniforms.u_time.value=time;
        _tv.lerpVectors(grp.userData.startPos,grp.userData.scatterPos,state.spread);
        _tv.y+=Math.sin(time*1.7+grp.userData.floatOff)*.3*state.spread;
        grp.position.copy(_tv);
        grp.quaternion.copy(camera.quaternion);
    });

    // Tick border particles and keep them attached to the selected photo
    if(bpMesh.visible && state.selectedPhoto){
        tickBorderParticles();
        bpMesh.position.copy(state.selectedPhoto.position);
        bpMesh.quaternion.copy(camera.quaternion);
    }

    // ‚îÄ‚îÄ Selective bloom render ‚îÄ‚îÄ
    // Pass 1: Darken photos ‚Üí bloom only affects particles
    _darkenPhotos();
    bloomComposer.render();
    _restorePhotos();

    // Pass 2: Final render = clean scene + bloom texture layered on top
    composer.render();
}
animate();

window.addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
    bloomComposer.setSize(innerWidth,innerHeight);
    composer.setSize(innerWidth,innerHeight);
});

}; // end startMemoriesExperience
</script>
</body>
</html>